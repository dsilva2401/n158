{"version":3,"sources":["../src/resources/http-pipeline-handlers/mongo-model-transaction.js"],"names":["context","next","finish","CurrentModel","params","model","db","resolveParamPath","obj","paramPath","buffObj","split","forEach","k","JSON","parse","stringify","resolveAttributes","value","fValue","req","substring","length","buffK","buffK1","buffK2","get","Array","isArray","Object","keys","map","item","transactionParams","rf","resolveRoute","transaction","apply","then","resp","catch","status"],"mappings":"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","file":"mongo-model-transaction.js","sourcesContent":["import q from 'q';\n\nexport default (context, next, finish) => {\n    var CurrentModel = context.params.model;\n    var model = new CurrentModel(context.params.db);\n\n    var resolveParamPath = (obj, paramPath) => {\n        var buffObj = obj;\n        paramPath.split('.').forEach((k) => {\n            // buffObj = (typeof buffObj[k] == 'undefined') ? {} : buffObj[k];\n            switch (typeof buffObj[k]) {\n                case 'undefined':\n                    buffObj = null;\n                break;\n                case 'object':\n                    buffObj = JSON.parse(JSON.stringify(buffObj[k]));\n                break;\n                default:\n                    buffObj = buffObj[k];\n                break;\n            }\n        });\n        return buffObj;\n    }\n\n    var resolveAttributes = (value) => {\n        var fValue;\n        if (typeof value == 'object') {\n            fValue = JSON.parse(JSON.stringify(value));\n        } else {\n            fValue = value;\n        }\n        if (typeof fValue == 'string') {\n            if (fValue[0] == '&') {\n                fValue = resolveParamPath(\n                    context.req, fValue.substring(1, fValue.length)\n                );\n            }\n            if (fValue[0] == '%') {\n                var buffK = fValue.substring(1, fValue.length);\n                var buffK1 = buffK.split('.')[0];\n                var buffK2 = buffK.split('.')[1] || '';\n                fValue = resolveParamPath(context.get(buffK1), buffK2);\n            }\n        } else if (typeof fValue == 'object') {\n            if ( !Array.isArray(fValue) ) {\n                Object.keys(fValue).forEach((k) => {\n                    fValue[k] = resolveAttributes(fValue[k]);\n                });\n            } else {\n                fValue = fValue.map((item) => {\n                    return resolveAttributes(item);\n                });\n            }\n        }\n        return fValue;\n    }\n\n    var transactionParams = resolveAttributes(context.params.transactionParams);\n    \n    var rf = (context.params.resolveRoute ? finish : next);\n\n    if (!model) {\n        rf(404, 'Model not found');\n        return;\n    }\n    if (!context.params.transaction) {\n        rf(404, 'Transaction not found');\n        return;\n    }\n    if (!model[context.params.transaction]) {\n        rf(404, 'Model transaction not found');\n        return;\n    }\n\n    model[context.params.transaction].apply(model, transactionParams).then((resp) => {\n        rf(200, resp);\n    }).catch((resp) => {\n        rf(resp.status || 500, resp);\n    });\n}"]}